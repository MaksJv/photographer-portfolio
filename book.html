<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book a Photo Session</title>
  <link rel="shortcut icon" href="img/logo.webp" type="image/x-icon" />
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="css/photo-sessions.css" />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
</head>
<body>
  <header class="header">
    <div class="header__background">
      <div class="header__container container">
        <nav data-include="header-nav.partial.html"></nav>
        <section class="book-header">
          <h1 class="book-title">Book a Photo Session</h1>
          <p class="book-subtitle">Let’s create something magical together</p>
        </section>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="book-form-section">
      <p class="container-book">Book a Photo Session</p>
      <form class="book-form" action="http://localhost:8080/api/bookings" method="POST">
        <label>
          Your Name
          <input type="text" name="name" placeholder="John Doe" required />
        </label>
        <label>
          Email
          <input type="email" name="email" placeholder="you@example.com" required />
        </label>
        <label>
          Preferred Date
          <input type="text" id="datePicker" name="date" placeholder="Select date" required />
        </label>
        <label>
          Preferred Time
          <div class="time-options">
            <label class="time-option" id="time-9-container">
              <input type="radio" name="time" value="09:00" id="time-9" required>
              <span>09:00</span>
            </label>
            <label class="time-option" id="time-14-container">
              <input type="radio" name="time" value="14:00" id="time-14" required>
              <span>14:00</span>
            </label>
          </div>
        </label>
        <label>
          Select photosession type
          <select name="photosession_type" id="photosession-type" class="custom-select" required>
            <option value="" disabled selected>Loading types...</option>
          </select>
        </label>
        <label>
          Message
          <textarea name="message" placeholder="Tell me more..."></textarea>
        </label>
        <input type="hidden" name="_captcha" value="false" />
        <button type="submit" class="book-submit-button">Submit</button>
      </form>
    </section>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
  <footer data-include="footer.partial.html"></footer>

  <script src="https://unpkg.com/html-data-include@3.3.3/html-data-include.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Polish locale -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pl.js"></script>

  <script>
    // ✅ Глобальні змінні
    let availableDates = [];
  
    // ✅ Завантаження доступних дат
    async function fetchAvailableDates() {
      try {
        const response = await fetch("http://localhost:8080/api/bookings/available-dates");
        if (!response.ok) throw new Error("Failed to fetch available dates");
        availableDates = await response.json();
      } catch (error) {
        console.error("Error fetching dates:", error);
        availableDates = []; // fallback
      }
    }
  
    // ✅ Завантаження типів фотосесій
    async function fetchPhotosessionTypes() {
      try {
        const response = await fetch("http://localhost:8080/api/photosession-types");
        if (!response.ok) throw new Error("Failed to load types");
  
        const types = await response.json();
        const select = document.getElementById("photosession-type");
  
        types.forEach(type => {
          const option = document.createElement("option");
          option.value = type.id;
          option.textContent = type.name;
          select.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading photosession types:", err);
      }
    }
  
    // ✅ Перевірка доступності часу (залежно від обраної дати)
    function checkAvailability() {
      const selectedDate = document.querySelector('input[name="date"]').value;
      // Тут можна реалізувати додаткову логіку, якщо потрібно
      console.log("Selected date:", selectedDate);
    }
  
    // ✅ DOMContentLoaded
    document.addEventListener("DOMContentLoaded", async function () {
      await fetchAvailableDates();
      await fetchPhotosessionTypes();
  
      flatpickr("#datePicker", {
        dateFormat: "Y-m-d",
        minDate: "today",
        locale: "pl",
        onOpen: async function () {
          await fetchAvailableDates();
          this.redraw();
        },
        onDayCreate: function (dObj, dStr, fp, dayElem) {
          const date = dayElem.dateObj.toISOString().split("T")[0];
          if (availableDates.includes(date)) {
            dayElem.classList.add("available-day");
            dayElem.classList.remove("flatpickr-disabled");
          } else {
            dayElem.classList.add("unavailable-day");
            dayElem.classList.add("flatpickr-disabled");
          }
        }
      });

      const form = document.querySelector(".book-form");

    form.addEventListener("submit", async (event) => {
      event.preventDefault(); // зупиняємо стандартне надсилання

      const formData = new FormData(form);

      const payload = {
        name: formData.get("name"),
        email: formData.get("email"),
        date: formData.get("date"),
        time: formData.get("time"),
        photosessionTypeId: parseInt(formData.get("photosession_type")),
        message: formData.get("message")
      };
      

      try {
        console.log("Form data being sent:", formData);
        console.log("Payload being sent:", payload);


        const response = await fetch("http://localhost:8080/api/bookings", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          showToast("Your booking was submitted successfully! ✅");
          form.reset(); // очистити форму
        } else {
          showToast("Something went wrong. Please try again later. ❌");
        }
      } catch (error) {
        console.error("Submit error:", error);
        showToast("Failed to connect to the server. ❌");
      }
    });

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, 4000);
    }
  
      document.querySelector('input[name="date"]').addEventListener('change', checkAvailability);

      // Ініціалізація Flatpickr
    flatpickr("#datePicker", {
      async onOpen() {
        await fetchAvailableDates(); // Оновлюємо доступні дати при кожному відкритті календаря
        this.redraw(); // Перемальовуємо календар після оновлення доступних дат
      },
      onDayCreate: function(dObj, dStr, fp, dayElem) {
        const year = dayElem.dateObj.getFullYear();
        const month = String(dayElem.dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dayElem.dateObj.getDate()).padStart(2, '0');
        const date = `${year}-${month}-${day}`;
      
        console.log("Checking date:", date);
      
        if (availableDates.includes(date)) {
          console.log(`${date} is available.`);
          dayElem.classList.add("available-day");
          dayElem.classList.remove("flatpickr-disabled");
        } else {
          console.log(`${date} is unavailable.`);
          dayElem.classList.add("unavailable-day");
          dayElem.classList.add("flatpickr-disabled");
        }
      },
      // Додатково: встановлюємо мінімальну та максимальну дату, якщо необхідно
      minDate: "today", // не можна вибрати минулі дати
    });
    });
  </script>
</body>
</html>
